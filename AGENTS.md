# AAI Gateway - Agent Maintenance Guide

**Status**: MVP Complete (v0.1.0)

This guide provides instructions for AI Agents (and human developers) working on the AAI Gateway codebase.

## 1. Project Overview

AAI (Agent App Interface) Gateway acts as a bridge between LLM Agents (via Model Context Protocol) and local applications (via platform-native automation like AppleScript, COM, DBus).

**Goal**: Enable Agents to invoke desktop app capabilities without GUI automation.

## 2. Project Structure

- `src/mcp/`: Core MCP Server implementation (`server.ts`).
- `src/executors/`: Platform automation implementations.
  - `base.ts`: Executor interface.
  - `macos.ts`: AppleScript/JXA executor.
  - `windows.ts`: COM executor.
  - `linux.ts`: DBus executor.
  - `param-transform.ts`: Parameter substitution logic.
- `src/config/`: Configuration management.
  - `discovery.ts`: App discovery (`~/.aai`).
  - `config-loader.ts`: Gateway config (`~/.aai/config.json`).
  - `watcher.ts`: Hot-reload logic.
  - `ai-generator.ts`: LLM-based config generation.
- `src/web/`: Built-in Web UI server.
- `src/utils/`: Utilities (logger, retry, rate-limiter, metrics, cache).
- `src/parsers/`: JSON Schema definitions and validation.
- `tests/`: Test suite (Unit, Integration, E2E, Performance).

## 3. Development Workflow

### Build

```bash
npm run build
```

### Test

```bash
npm test
```

### Run

```bash
# Run via TS-Node (dev)
npm start -- --mcp

# Run built version
node dist/cli.js --mcp
```

## 4. Key Maintenance Tasks

### Adding a New Executor

1. Create `src/executors/<platform>.ts` implementing `AutomationExecutor`.
2. Register the executor in `src/mcp/server.ts` or `src/executors/base.ts` factory.
3. Update `src/parsers/schema.ts` to support platform-specific schema in `aai.json`.
4. Update `README.md` documentation.

### Updating Protocol Schema

1. Modify `src/parsers/schema.ts` (Zod definition).
2. Update `README.md` Appendix C (JSON Schema reference).
3. Ensure backward compatibility if possible.

### Improving Web UI

1. Modify `src/web/server.ts` (currently server-side rendered HTML).
2. For complex UI updates, consider extracting frontend to separate React app (Phase 5 plan).

## 5. Testing Guidelines

- **Unit Tests**: Place in `tests/unit/`. Mock external dependencies (fs, child_process).
- **Integration Tests**: Place in `tests/integration/`. Test interaction between components.
- **E2E Tests**: Place in `tests/e2e/`. These require actual platform environment (e.g., macOS with Reminders app).
- **Performance Tests**: Place in `tests/performance/`.

## 6. Release Process

1. Update version in `package.json`.
2. Update `CHANGELOG.md`.
3. Run full test suite: `npm test`.
4. Tag commit with version number (e.g., `v0.1.0`).
5. Publish to npm (if applicable).

---

_Generated by AAI Orchestrator_

When implementing, choose from these recommended stacks:

| Component          | TypeScript Options                   | Python Options                   |
| ------------------ | ------------------------------------ | -------------------------------- |
| MCP Server         | `@modelcontextprotocol/sdk`          | Official Python SDK              |
| aai.json Parsing   | `ajv`                                | `jsonschema`                     |
| macOS Automation   | `osascript` CLI / Node child_process | `pyobjc`                         |
| Windows Automation | `node-ffi-napi` / edge-js            | `pywin32` / `win32com`           |
| Linux Automation   | `dbus-typescript`                    | `dbus-python`                    |
| Build Tool         | `vite` or `rollup`                   | `setuptools` or `pyproject.toml` |
| Testing            | `vitest`                             | `pytest`                         |

---

## Code Style Guidelines (To Be Established)

### When Starting Implementation, Define:

**Naming Conventions** (choose one consistent style):

- camelCase for variables/functions (JavaScript/TypeScript)
- PascalCase for classes/components (JavaScript/TypeScript)
- snake_case for Python

**Import Organization** (if using TypeScript/JavaScript):

```typescript
// 1. Node.js built-ins
import { createServer } from 'http';

// 2. External packages
import { Server } from '@modelcontextprotocol/sdk';

// 3. Internal modules
import { AutomationExecutor } from './executors';
```

**Error Handling**:

- Use structured error types (see Appendix C in README for error code definitions)
- Always include error code and user-friendly message
- Log errors with context

**Type Safety**:

- Use TypeScript strict mode (`"strict": true` in tsconfig.json)
- Define interfaces for all aai.json structures
- Validate JSON schemas at runtime

---

## File Structure Convention (Recommended)

```
src/
├── mcp/
│   ├── server.ts          # MCP server implementation
│   └── handlers/         # resources/list, resources/read, tools/call
├── executors/
│   ├── base.ts           # Abstract executor interface
│   ├── macos.ts         # AppleScript/JXA executor
│   ├── windows.ts       # COM automation executor
│   ├── linux.ts         # DBus executor
│   ├── android.ts       # Intent executor
│   └── ios.ts          # URL Scheme executor
├── parsers/
│   └── aai-parser.ts    # aai.json parser and validator
├── config/
│   └── app-discovery.ts  # App discovery and scanning
├── errors/
│   └── errors.ts        # Custom error types
└── index.ts             # Main entry point
```

---

## Configuration Conventions

### aai.json Location (per protocol spec):

- **macOS/Linux**: `~/.aai/<appId>/aai.json`
- **Windows**: `%USERPROFILE%\.aai\<appId>\aai.json`

### Gateway Config (to be created):

- Location: `~/.aai/config.json`
- Contains: scan paths, timeouts, logging levels

---

## Testing Conventions (To Be Established)

When adding tests:

**Test Structure**:

```typescript
describe('AppleScriptExecutor', () => {
  describe('execute', () => {
    it('should execute AppleScript and return parsed result', async () => {
      // Given
      const script = '...';
      // When
      const result = await executor.execute(script);
      // Then
      expect(result).toEqual({ success: true });
    });
  });
});
```

**Test Categories**:

- Unit tests: Individual executor functions
- Integration tests: MCP server + platform automation
- Schema tests: aai.json validation

---

## Documentation Conventions

### Code Documentation:

- Use JSDoc (TypeScript) or docstrings (Python) for all public APIs
- Document `appId`, `platform`, and tool parameters clearly

### README Updates:

- When adding features, update README's "Roadmap" section
- Document new platform automation methods with examples

---

## Platform-Specific Considerations

### macOS:

- AppleScript uses `${param}` syntax for parameter substitution
- First execution triggers TCC authorization popup (document in error messages)
- Use `osascript -e` for single-line scripts or temp files for multi-line
- **Escaping**: `\` → `\\`, `"` → `\"`, `\n` → `\\n`, `\t` → `\\t`

### Windows:

- COM requires ProgID registration (e.g., `Outlook.Application`)
- May require UAC elevation for certain operations
- Use structured script array: `[{"action": "create", ...}, {"action": "call", ...}]`
- **Escaping**: `` ` `` → ` `` `, `"` → `` `" ``, `$` → `` `$ ``

### Linux:

- DBus requires service name, object path, and interface
- Use session bus (`SessionBus()` in Python)
- **Escaping**: `\` → `\\`, `"` → `\"`

### Android:

- Intent requires package name and action string
- Results via ContentProvider or broadcast

### iOS:

- URL Scheme requires custom scheme registration
- Results via App Groups or clipboard

---

## Parameter Transform Rules

The Gateway uses `param-transform.ts` for secure parameter handling:

### Type Transformations

| Type      | AppleScript   | PowerShell     | DBus                        |
| --------- | ------------- | -------------- | --------------------------- |
| `boolean` | `true/false`  | `$true/$false` | `boolean:true`              |
| `number`  | `42`          | `42`           | `int32:42` or `double:3.14` |
| `string`  | escaped value | escaped value  | `string:"value"`            |
| `array`   | `{"a", "b"}`  | `@("a", "b")`  | JSON string                 |

### Security: Injection Prevention

All string parameters are escaped before substitution:

```typescript
// Input: 'Hello"; do shell script "rm -rf /"'
// Escaped: 'Hello\\"; do shell script \\"rm -rf /\\"'
// Result: Safe string in script
```

### Validation

Parameters are validated against JSON Schema before execution:

```typescript
validateParamTypes(args, tool.parameters);
// Returns: { valid: boolean, errors: string[] }
```

---

## Security Best Practices (from README)

**Critical**: Use OS-native security - DO NOT implement custom auth:

- macOS: Relies on TCC (Transparency, Consent, and Control)
- Windows: Relies on UAC or app's own COM security
- Linux: Relies on Polkit
- Android: Runtime permissions
- iOS: Sandbox + URL Scheme restrictions

**Never**:

- Implement custom authentication protocols
- Store credentials in Gateway
- Bypass OS security mechanisms

---

## Error Handling Patterns

Use standardized error codes from Appendix C in README:

```typescript
class AutomationError extends Error {
  constructor(code: number, message: string, detail?: string) {
    super(message);
    this.name = 'AutomationError';
    this.code = code;
    this.detail = detail;
  }
}

// Usage:
throw new AutomationError(-32001, 'Automation failed', 'Script execution timed out');
```

**Common Error Codes**:

- `-32001`: AUTOMATION_FAILED
- `-32002`: APP_NOT_FOUND
- `-32004`: PERMISSION_DENIED
- `-32008`: TIMEOUT

---

## Debugging Guidelines

**Logging** (to be implemented):

- Structured JSON logs for automated parsing
- Log levels: DEBUG, INFO, WARN, ERROR
- Include context: `appId`, `tool`, `platform`, `duration`

**Common Issues**:

- **TCC authorization failed** (macOS): User denied, check System Settings > Privacy
- **COM not registered** (Windows): App doesn't support automation
- **DBus service not found** (Linux): App not running or not installed

---

## MCP Integration Notes

Gateway implements MCP over stdio (not HTTP):

**Resource Model** (progressive loading):

- `resources/list` → Returns all available apps (`app:com.apple.mail`, etc.)
- `resources/read` → Returns specific app's aai.json content
- `tools/call` → Executes tool with parameters

**Why Progressive?** Avoids context explosion - only load app's tools when agent mentions it.

---

## Verification Checklist (for each PR)

Before submitting changes:

- [ ] All tests pass
- [ ] TypeScript compiles with no errors
- [ ] Linting passes (ESLint/flake8)
- [ ] Code follows naming conventions
- [ ] Error handling uses standardized error codes
- [ ] Platform-specific code is isolated to executor files
- [ ] Documentation updated (README or inline docs)
- [ ] aai.json schema changes are backward compatible

---

## Key Architectural Decisions (From Protocol Spec)

**Zero Intrusion Design**:

- Gateway doesn't modify target apps
- Leverages existing automation (AppleScript/COM/DBus)
- No HTTP server required (MCP over stdio only)

**Platform Native Automation**:

- Don't implement custom IPC
- Use what each OS provides natively

**Progressive Tool Discovery**:

- Don't load all apps/tools at startup
- Load on-demand via MCP resources

---

## Getting Started with Implementation

### Step 1: Initialize Project

```bash
npm init -y  # or: python -m venv venv
npm install @modelcontextprotocol/sdk  # or: pip install mcp
```

### Step 2: Create Basic Structure

```
src/
├── server.ts          # Minimal MCP server
├── executors/
│   └── macos.ts      # Start with one platform
└── aai-parser.ts      # Parse aai.json
```

### Step 3: Test Sample aai.json

Create `~/.aai/com.apple.mail/aai.json` (see README example)

### Step 4: Implement MCP Handlers

```typescript
async function handleToolCall(name: string, args: any) {
  const [appId, tool] = name.split(':');
  const config = await loadAaiConfig(appId);
  const executor = getExecutor(config.platform);
  return await executor.execute(tool, args);
}
```

---

## Contact & Contribution

This protocol is in early design phase. Implementation patterns will evolve as we build.

**Before making architectural changes**:

1. Read README.md Section 2 (Technical Specifications) thoroughly
2. Check Appendix B (Implementation Reference)
3. Verify change doesn't break "Zero Intrusion" principle

---

_Last Updated: 2025-02-06_
_Protocol Version: 1.0_
